<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>FLASH ANZAN GAME â€” è¶…æœ¬æ ¼ç‰ˆ</title>
  <style>
    :root{
      --bg:#0b0b10; --fg:#f2f4f8; --muted:#b6c2cf; 
      --accent1:#00e5ff; --accent2:#ff4d6d; --accent3:#ffd166; 
      --panel:#10131a; --gold:#ffd700; --silver:#c0c0c0; --bronze:#cd7f32;
    }
    *{box-sizing:border-box}
    html,body{height:100%; margin:0; background:radial-gradient(120% 150% at 10% -10%, #122 0%, #0b0b10 55%, #050507 100%); color:var(--fg); font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Noto Sans JP",sans-serif; overflow-x:hidden}
    .wrap{min-height:100%; display:grid; grid-template-rows:auto 1fr auto}
    
    header{padding:10px 14px; display:flex; gap:8px; align-items:center; flex-wrap:wrap; opacity:.95}
    .badge{font-size:11px; padding:4px 10px; border:1px solid #fff2; border-radius:999px; font-weight:600; letter-spacing:.03em; white-space:nowrap}
    .badge.level{background:linear-gradient(135deg,#667eea,#764ba2); border-color:#667eea}
    .badge.score{background:linear-gradient(135deg,#f093fb,#f5576c); border-color:#f093fb}
    .badge.rank{background:linear-gradient(135deg,#ffd700,#ffed4e); color:#1a0b00; border:none; font-weight:900}
    
    .stage{position:relative; display:grid; place-items:center; padding:20px}
    .panel{width:min(1100px,96vw); border-radius:16px; background:linear-gradient(180deg,#ffffff0c,#00000040); box-shadow:0 10px 30px #0007; padding:18px; position:relative; overflow:hidden}
    .title{font-size:clamp(20px,4vw,36px); font-weight:900; margin:8px 6px}
    .subtitle{margin:0 6px 12px; opacity:.82; font-size:14px}

    .grid{display:grid; grid-template-columns:1.3fr 1fr; gap:16px}
    @media (max-width:960px){.grid{grid-template-columns:1fr}}

    .board{display:grid; place-items:center; border-radius:14px; background:radial-gradient(100% 120% at 50% 20%, #ffffff12, #00000033); min-height:380px; position:relative; overflow:hidden}
    .number{font-weight:1000; letter-spacing:.04em; text-shadow:0 10px 40px #000; user-select:none; transition:transform .15s, opacity .15s}
    .number.main{font-size:clamp(54px,14vw,160px); z-index:2}
    .number.ghost{position:absolute; opacity:.08; filter:blur(6px); font-size:clamp(80px,24vw,240px); z-index:1}
    .number.pulse{animation:pulse .3s ease-out}
    @keyframes pulse{0%,100%{transform:scale(1)} 50%{transform:scale(1.15)}}

    .combo-display{position:absolute; top:20px; right:20px; font-size:48px; font-weight:900; opacity:0; transform:scale(.5); transition:all .3s; pointer-events:none; z-index:10; text-shadow:0 4px 20px #000}
    .combo-display.show{opacity:1; transform:scale(1)}
    .combo-display.mega{background:linear-gradient(135deg,#f093fb,#f5576c); -webkit-background-clip:text; -webkit-text-fill-color:transparent; background-clip:text}

    .powerups{display:flex; gap:6px; margin:8px 0; flex-wrap:wrap}
    .powerup{padding:6px 12px; border-radius:8px; font-size:11px; font-weight:700; cursor:pointer; border:1px solid #fff3; background:linear-gradient(135deg,#667eea44,#764ba244); transition:all .2s}
    .powerup:hover{transform:translateY(-2px); box-shadow:0 4px 12px #667eea88}
    .powerup:disabled{opacity:.4; cursor:not-allowed; transform:none}
    .powerup.active{background:linear-gradient(135deg,#667eea,#764ba2); border-color:#667eea; box-shadow:0 0 16px #667eeaaa}

    .controls{border-radius:14px; background:linear-gradient(180deg,#ffffff10,#00000030); padding:14px; display:grid; gap:10px}
    .row{display:flex; gap:10px; flex-wrap:wrap; align-items:center}
    label{font-size:12px; opacity:.8; white-space:nowrap}
    input[type=number],select{all:unset; background:#ffffff18; padding:8px 10px; border-radius:10px; font-weight:700; min-width:64px}
    button{all:unset; cursor:pointer; padding:10px 14px; border-radius:12px; border:1px solid #ffffff22; background:linear-gradient(120deg,var(--accent1),#2dd4bf); color:#041218; font-weight:900; letter-spacing:.05em; box-shadow:0 8px 20px #0008; transition:transform .15s}
    button:hover{transform:translateY(-2px)}
    button:active{transform:translateY(0)}
    button.secondary{background:linear-gradient(180deg,#ffffff20,#00000020); color:var(--fg)}
    button.danger{background:linear-gradient(120deg,#ff4d6d,#ffb703); color:#1a0b00}
    button:disabled{opacity:.5; cursor:not-allowed; transform:none}

    .meter{height:8px; background:#ffffff18; border-radius:999px; overflow:hidden; position:relative}
    .meter>div{height:100%; width:0%; background:linear-gradient(90deg,var(--accent2),var(--accent3)); transition:width .2s}

    .statgrid{display:grid; grid-template-columns:repeat(auto-fit,minmax(110px,1fr)); gap:8px}
    .stat{background:#00000026; border:1px solid #ffffff14; border-radius:10px; padding:8px 10px}
    .label{font-size:11px; opacity:.7}
    .value{font-size:20px; font-weight:900; line-height:1.2}

    .answerBox{display:flex; gap:10px; justify-content:center; align-items:center; flex-wrap:wrap}
    .answerBox input{all:unset; background:#ffffff18; padding:14px 16px; border-radius:12px; font-size:26px; font-weight:900; width:200px; text-align:center; border:2px solid transparent; transition:border-color .2s}
    .answerBox input:focus{border-color:var(--accent1)}

    .achievements{display:grid; grid-template-columns:repeat(auto-fill,minmax(140px,1fr)); gap:8px; max-height:160px; overflow:auto; padding:4px}
    .achievement{background:#00000033; border:1px solid #ffffff14; border-radius:10px; padding:8px; text-align:center; font-size:11px; transition:all .2s}
    .achievement.unlocked{border-color:var(--gold); background:linear-gradient(135deg,#ffd70033,#ffed4e22); transform:scale(1.02)}
    .achievement .icon{font-size:24px; margin-bottom:4px}
    .achievement .name{font-weight:700; margin:2px 0}
    .achievement .desc{opacity:.6; font-size:10px}

    .log{max-height:140px; overflow:auto; font-family:ui-monospace,SFMono-Regular,Menlo,monospace; font-size:11px; opacity:.85; background:#00000026; border:1px solid #ffffff14; border-radius:12px; padding:10px}
    .ok{color:#7ee787}
    .ng{color:#ff7b72}
    .combo-log{color:#ffd700; font-weight:700}

    .particles{position:absolute; inset:0; pointer-events:none; z-index:5}
    .particle{position:absolute; width:8px; height:8px; border-radius:50%; background:var(--accent1); opacity:0; animation:particle-fly 1s ease-out forwards}
    @keyframes particle-fly{
      0%{transform:translate(0,0) scale(1); opacity:1}
      100%{transform:translate(var(--tx),var(--ty)) scale(0); opacity:0}
    }

    footer{padding:10px 14px; font-size:11px; opacity:.7}
    details summary{cursor:pointer; padding:8px; background:#ffffff08; border-radius:8px; margin:4px 0; font-weight:600}
    details[open] summary{margin-bottom:8px}

    .level-up-banner{position:fixed; top:50%; left:50%; transform:translate(-50%,-50%) scale(.5); font-size:64px; font-weight:900; opacity:0; pointer-events:none; z-index:100; text-shadow:0 8px 30px #000; transition:all .5s}
    .level-up-banner.show{opacity:1; transform:translate(-50%,-50%) scale(1)}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="badge level" id="levelBadge">LV.1</div>
      <div class="badge score" id="scoreBadge">SCORE: 0</div>
      <div class="badge rank" id="rankBadge">RANK: C</div>
      <div class="badge">BEST: <span id="bestScore">0</span></div>
      <div class="badge">STREAK: <span id="streakBadge">0</span></div>
    </header>

    <main class="stage">
      <div class="panel">
        <h1 class="title">ğŸ® FLASH ANZAN GAME</h1>
        <p class="subtitle">é€£ç¶šæ­£è§£ã§ãƒ¬ãƒ™ãƒ«ã‚¢ãƒƒãƒ—ï¼†ã‚³ãƒ³ãƒœãƒœãƒ¼ãƒŠã‚¹ï¼ãƒ‘ãƒ¯ãƒ¼ã‚¢ãƒƒãƒ—ã‚’é§†ä½¿ã—ã¦é«˜å¾—ç‚¹ã‚’ç‹™ãˆï¼</p>

        <div class="grid">
          <section class="board" id="board">
            <div class="particles" id="particles"></div>
            <div class="combo-display" id="comboDisplay">COMBOÃ—0</div>
            <div class="number ghost" id="ghost">888</div>
            <div class="number main" id="main">READY</div>
          </section>

          <aside class="controls">
            <div class="powerups" id="powerups">
              <button class="powerup" id="pwSlowTime" title="æ¬¡ã®å•é¡Œã®è¡¨ç¤ºæ™‚é–“1.5å€">â±ï¸ æ™‚é–“å»¶é•·</button>
              <button class="powerup" id="pwHint" title="æœ€åˆã®æ•°å­—ã‚’ã‚‚ã†ä¸€åº¦è¡¨ç¤º">ğŸ’¡ ãƒ’ãƒ³ãƒˆ</button>
              <button class="powerup" id="pwSkip" title="ã“ã®å•é¡Œã‚’ã‚¹ã‚­ãƒƒãƒ—">â­ï¸ ã‚¹ã‚­ãƒƒãƒ—</button>
            </div>

            <div class="row">
              <label>é›£æ˜“åº¦</label>
              <select id="difficulty">
                <option value="easy">åˆç´š</option>
                <option value="normal" selected>ä¸­ç´š</option>
                <option value="hard">ä¸Šç´š</option>
                <option value="extreme">è¶…ç´š</option>
              </select>
              <label>ãƒ¢ãƒ¼ãƒ‰</label>
              <select id="mode">
                <option value="normal" selected>é€šå¸¸</option>
                <option value="time">ã‚¿ã‚¤ãƒ ã‚¢ã‚¿ãƒƒã‚¯</option>
                <option value="endless">ã‚¨ãƒ³ãƒ‰ãƒ¬ã‚¹</option>
              </select>
            </div>

            <div class="row">
              <button id="start">ğŸš€ é–‹å§‹ (Space)</button>
              <button class="secondary" id="stop">â¹ï¸ åœæ­¢</button>
              <button class="secondary" id="resetProgress">â™»ï¸ é€²è¡Œãƒªã‚»ãƒƒãƒˆ</button>
            </div>

            <div class="meter"><div id="progress"></div></div>

            <div class="statgrid">
              <div class="stat"><div class="label">ãƒ¬ãƒ™ãƒ«</div><div class="value" id="levelNum">1</div></div>
              <div class="stat"><div class="label">ã‚¹ã‚³ã‚¢</div><div class="value" id="scoreNum">0</div></div>
              <div class="stat"><div class="label">ã‚³ãƒ³ãƒœ</div><div class="value" id="comboNum">Ã—1</div></div>
              <div class="stat"><div class="label">æ­£è§£ç‡</div><div class="value" id="accuracy">--%</div></div>
              <div class="stat"><div class="label">å•é¡Œæ•°</div><div class="value" id="questionCount">0</div></div>
              <div class="stat"><div class="label">æœ€å¾Œã®çµæœ</div><div class="value" id="last">--</div></div>
            </div>

            <div class="answerBox" id="answerBox" style="display:none">
              <input id="answer" type="number" inputmode="numeric" placeholder="ç­”ãˆã‚’å…¥åŠ›" />
              <button class="danger" id="submit">âœ“ åˆ¤å®š (Enter)</button>
            </div>

            <details>
              <summary>ğŸ† ã‚¢ãƒãƒ¼ãƒ–ãƒ¡ãƒ³ãƒˆ</summary>
              <div class="achievements" id="achievements"></div>
            </details>

            <details>
              <summary>ğŸ“œ å±¥æ­´</summary>
              <div class="log" id="log"></div>
            </details>
          </aside>
        </div>
      </div>
    </main>

    <footer>Â© 2025 Flash Anzan Game â€” è¶…æœ¬æ ¼ç‰ˆ | ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰: Space=é–‹å§‹, Enter=åˆ¤å®š, 1/2/3=ãƒ‘ãƒ¯ãƒ¼ã‚¢ãƒƒãƒ—</footer>
  </div>

  <div class="level-up-banner" id="levelUpBanner">LEVEL UP!</div>

<script>
(() => {
  const $ = id => document.getElementById(id);
  const main = $('main'), ghost = $('ghost'), progress = $('progress');
  const startBtn = $('start'), stopBtn = $('stop'), resetBtn = $('resetProgress');
  const diffSel = $('difficulty'), modeSel = $('mode');
  const answerBox = $('answerBox'), answerInput = $('answer'), submitBtn = $('submit');
  const logEl = $('log'), particles = $('particles'), comboDisplay = $('comboDisplay');
  const levelBadge = $('levelBadge'), scoreBadge = $('scoreBadge'), rankBadge = $('rankBadge');
  const bestScoreEl = $('bestScore'), streakBadgeEl = $('streakBadge');
  const levelNum = $('levelNum'), scoreNum = $('scoreNum'), comboNum = $('comboNum');
  const accuracyEl = $('accuracy'), questionCountEl = $('questionCount'), lastEl = $('last');
  const achievementsEl = $('achievements'), levelUpBanner = $('levelUpBanner');
  const pwSlowTime = $('pwSlowTime'), pwHint = $('pwHint'), pwSkip = $('pwSkip');

  const audio = new (window.AudioContext || window.webkitAudioContext)();
  function beep(freq=660, dur=0.05, vol=0.12, type='sine'){
    const o = audio.createOscillator(), g = audio.createGain();
    o.type=type; o.frequency.value=freq; g.gain.value=vol;
    o.connect(g).connect(audio.destination); o.start(); o.stop(audio.currentTime+dur);
  }
  function playCombo(combo){
    const freq = 440 + combo*30;
    beep(freq, .06, .14, 'square');
    setTimeout(()=>beep(freq*1.5, .04, .1, 'square'), 60);
  }
  function playLevelUp(){
    [0,100,200].forEach((t,i)=> setTimeout(()=>beep(523+i*100, .1, .15), t));
  }
  function playCorrect(){ beep(880, .08, .16); }
  function playWrong(){ beep(180, .3, .15); }

  let running=false, seq=[], idx=0, timer=null, total=0;
  let level=1, score=0, combo=0, streak=0, bestScore=+(localStorage.getItem('fa_best_score')||0);
  let totalQuestions=0, correctAnswers=0;
  let slowTimePower=0, hintPower=0, skipPower=0;
  let currentDifficulty = {digits:2, count:10, speed:500};
  
  const achievements = [
    {id:'first', icon:'ğŸ¯', name:'åˆå‹åˆ©', desc:'åˆã‚ã¦æ­£è§£', unlocked:false},
    {id:'streak5', icon:'ğŸ”¥', name:'5é€£å‹', desc:'5å›é€£ç¶šæ­£è§£', unlocked:false},
    {id:'streak10', icon:'âš¡', name:'10é€£å‹', desc:'10å›é€£ç¶šæ­£è§£', unlocked:false},
    {id:'level5', icon:'ğŸŒŸ', name:'ãƒ¬ãƒ™ãƒ«5', desc:'Lv.5åˆ°é”', unlocked:false},
    {id:'level10', icon:'ğŸ’', name:'ãƒ¬ãƒ™ãƒ«10', desc:'Lv.10åˆ°é”', unlocked:false},
    {id:'score1000', icon:'ğŸ†', name:'1000ç‚¹', desc:'1000ç‚¹çªç ´', unlocked:false},
    {id:'combo10', icon:'ğŸ’¥', name:'10ã‚³ãƒ³ãƒœ', desc:'10ã‚³ãƒ³ãƒœé”æˆ', unlocked:false},
    {id:'perfect', icon:'âœ¨', name:'å®Œç’§', desc:'æ­£è§£ç‡100% (10å•ä»¥ä¸Š)', unlocked:false}
  ];

  function loadProgress(){
    const saved = localStorage.getItem('fa_progress');
    if(saved){
      const data = JSON.parse(saved);
      level = data.level || 1;
      score = data.score || 0;
      achievements.forEach((a,i)=> a.unlocked = data.achievements?.[i] || false);
    }
    updateAchievements();
    updateStats();
  }

  function saveProgress(){
    localStorage.setItem('fa_progress', JSON.stringify({
      level, score, achievements: achievements.map(a=>a.unlocked)
    }));
    localStorage.setItem('fa_best_score', String(Math.max(bestScore, score)));
  }

  function resetProgress(){
    if(!confirm('ãƒ¬ãƒ™ãƒ«ãƒ»ã‚¹ã‚³ã‚¢ãƒ»ã‚¢ãƒãƒ¼ãƒ–ãƒ¡ãƒ³ãƒˆã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã™ã‹ï¼Ÿ')) return;
    level=1; score=0; combo=0; streak=0; totalQuestions=0; correctAnswers=0;
    achievements.forEach(a=> a.unlocked=false);
    localStorage.removeItem('fa_progress');
    updateAchievements();
    updateStats();
    addLog('é€²è¡Œãƒ‡ãƒ¼ã‚¿ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã—ãŸ', 'info');
  }

  function updateAchievements(){
    achievementsEl.innerHTML = achievements.map(a=>`
      <div class="achievement ${a.unlocked?'unlocked':''}">
        <div class="icon">${a.icon}</div>
        <div class="name">${a.name}</div>
        <div class="desc">${a.desc}</div>
      </div>
    `).join('');
  }

  function checkAchievements(){
    const checks = [
      {id:'first', cond: correctAnswers>=1},
      {id:'streak5', cond: streak>=5},
      {id:'streak10', cond: streak>=10},
      {id:'level5', cond: level>=5},
      {id:'level10', cond: level>=10},
      {id:'score1000', cond: score>=1000},
      {id:'combo10', cond: combo>=10},
      {id:'perfect', cond: totalQuestions>=10 && correctAnswers===totalQuestions}
    ];
    checks.forEach(({id, cond})=>{
      const a = achievements.find(x=>x.id===id);
      if(a && !a.unlocked && cond){
        a.unlocked = true;
        addLog(`ğŸ† ã‚¢ãƒãƒ¼ãƒ–ãƒ¡ãƒ³ãƒˆè§£é™¤: ${a.name}`, 'combo-log');
        playLevelUp();
      }
    });
    updateAchievements();
  }

  function updateStats(){
    levelBadge.textContent = `LV.${level}`;
    scoreBadge.textContent = `SCORE: ${score}`;
    levelNum.textContent = level;
    scoreNum.textContent = score;
    comboNum.textContent = `Ã—${combo}`;
    streakBadgeEl.textContent = streak;
    bestScoreEl.textContent = bestScore;
    const acc = totalQuestions>0 ? Math.round(correctAnswers/totalQuestions*100) : 0;
    accuracyEl.textContent = acc+'%';
    questionCountEl.textContent = totalQuestions;
    
    const rank = score>=5000?'S': score>=3000?'A': score>=1500?'B': 'C';
    rankBadge.textContent = `RANK: ${rank}`;
    rankBadge.style.background = rank==='S'? 'linear-gradient(135deg,#ffd700,#ffed4e)':
      rank==='A'? 'linear-gradient(135deg,#c0c0c0,#e8e8e8)':
      rank==='B'? 'linear-gradient(135deg,#cd7f32,#e8a87c)':
      'linear-gradient(135deg,#888,#aaa)';
  }

  function getDifficultyParams(){
    const base = {
      easy: {digits:1, count:5, speed:700},
      normal: {digits:2, count:8, speed:500},
      hard: {digits:2, count:12, speed:350},
      extreme: {digits:3, count:15, speed:240}
    }[diffSel.value] || {digits:2, count:8, speed:500};
    
    const levelBonus = Math.floor((level-1)/3);
    return {
      digits: Math.min(4, base.digits + Math.floor(levelBonus/2)),
      count: Math.min(30, base.count + levelBonus),
      speed: Math.max(150, base.speed - levelBonus*20)
    };
  }

  function randInt(d){
    const min = Math.pow(10, d-1), max = Math.pow(10,d)-1;
    return Math.floor(Math.random()*(max-min+1))+min;
  }

  function makeSeq(){
    currentDifficulty = getDifficultyParams();
    const {digits, count} = currentDifficulty;
    seq = Array.from({length:count}, ()=> randInt(digits));
    total = seq.reduce((a,b)=>a+b, 0);
    idx = 0;
  }

  function showNumber(v){
    main.textContent = String(v);
    ghost.textContent = String(v);
    main.classList.add('pulse');
    setTimeout(()=> main.classList.remove('pulse'), 300);
  }

  function setProgress(p){ progress.style.width = Math.max(0,Math.min(1,p))*100 + '%'; }

  function resetBoard(){
    running=false; clearInterval(timer); timer=null; idx=0; seq=[]; setProgress(0);
    main.textContent='READY'; ghost.textContent='888'; answerBox.style.display='none';
    comboDisplay.classList.remove('show','mega');
  }

  function spawnParticles(x, y, count=12){
    for(let i=0; i<count; i++){
      const p = document.createElement('div');
      p.className = 'particle';
      p.style.left = x+'px'; p.style.top = y+'px';
      const angle = Math.random()*Math.PI*2;
      const dist = 50+Math.random()*100;
      p.style.setProperty('--tx', Math.cos(angle)*dist+'px');
      p.style.setProperty('--ty', Math.sin(angle)*dist+'px');
      particles.appendChild(p);
      setTimeout(()=> p.remove(), 1000);
    }
  }

  function start(){
    if(running) return;
    audio.resume?.();
    makeSeq(); running=true; setProgress(0); answerBox.style.display='none'; lastEl.textContent='--';
    
    slowTimePower=0; hintPower=0; skipPower=0;
    updatePowerupButtons();

    let pre=3; main.textContent='3'; ghost.textContent='3'; beep(520,.10,.14);
    const preT = setInterval(()=>{
      pre--;
      if(pre>0){ main.textContent=String(pre); ghost.textContent=String(pre); beep(520,.08,.12); }
      else{ clearInterval(preT); runSequence(); }
    }, 400);
  }

  function runSequence(){
    const N = seq.length;
    let speed = currentDifficulty.speed;
    if(slowTimePower>0){ speed*=1.5; slowTimePower--; }
    
    const gap = 100; let shown=0; setProgress(0);
    const show = ()=>{
      if(!running) return;
      if(shown>=N){ clearInterval(timer); timer=null; askAnswer(); return; }
      const v = seq[shown++]; showNumber(v); playCorrect();
      setProgress(shown/N);
    };
    show();
    timer = setInterval(show, speed+gap);
  }

  function askAnswer(){
    main.textContent = '= ?'; ghost.textContent='?';
    answerBox.style.display='flex'; answerInput.value=''; answerInput.focus();
  }

  function useHint(){
    if(hintPower<=0 || !running || seq.length===0) return;
    hintPower--;
    const hint = seq[0];
    addLog(`ğŸ’¡ ãƒ’ãƒ³ãƒˆä½¿ç”¨: æœ€åˆã®æ•°å­—ã¯ ${hint}`, 'combo-log');
    main.textContent = `HINT: ${hint}`;
    setTimeout(()=> main.textContent='= ?', 1500);
    updatePowerupButtons();
  }

  function useSkip(){
    if(skipPower<=0 || !running) return;
    skipPower--;
    addLog(`â­ï¸ ã‚¹ã‚­ãƒƒãƒ—ä½¿ç”¨`, 'combo-log');
    setTimeout(()=>{ resetBoard(); }, 300);
    updatePowerupButtons();
  }

  function updatePowerupButtons(){
    pwSlowTime.disabled = slowTimePower>=3;
    pwHint.disabled = hintPower>=2;
    pwSkip.disabled = skipPower>=1;
    pwSlowTime.textContent = `â±ï¸ æ™‚é–“å»¶é•· (${slowTimePower})`;
    pwHint.textContent = `ğŸ’¡ ãƒ’ãƒ³ãƒˆ (${hintPower})`;
    pwSkip.textContent = `â­ï¸ ã‚¹ã‚­ãƒƒãƒ— (${skipPower})`;
  }

  function submit(){
    if(!answerBox.style.display || answerBox.style.display==='none') return;
    const val = +answerInput.value;
    const ok = (val===total);
    totalQuestions++;

    if(ok){
      correctAnswers++;
      combo++;
      streak++;
      const basePoints = 100;
      const comboBonus = Math.min(combo, 20);
      const points = Math.round(basePoints * (1 + comboBonus*0.1));
      score += points;
      
      lastEl.textContent = 'âœ“ æ­£è§£';
      playCorrect();
      
      comboDisplay.textContent = combo>=10 ? `ğŸ”¥${combo}COMBO!` : `COMBOÃ—${combo}`;
      comboDisplay.classList.add('show');
      if(combo>=10) comboDisplay.classList.add('mega');
      setTimeout(()=> comboDisplay.classList.remove('show'), 1500);
      
      spawnParticles(400, 200, 15);
      playCombo(combo);

      addLog(`âœ“ æ­£è§£! +${points}pt (${combo}ã‚³ãƒ³ãƒœ) | seq:[${seq.join(',')}] ans:${total}`, 'ok');
      
      if(streak%5===0 && streak>0){
        level++;
        showLevelUp();
        playLevelUp();
        if(level%3===0){ slowTimePower++; }
        if(level%4===0){ hintPower++; }
        if(level===10){ skipPower++; }
      }
      
      checkAchievements();
      
    } else {
      combo=0; streak=0;
      lastEl.textContent = 'âœ— ä¸æ­£è§£';
      playWrong();
      comboDisplay.classList.remove('show','mega');
      addLog(`âœ— ä¸æ­£è§£ | seq:[${seq.join(',')}] ans:${total} you:${val}`, 'ng');
    }

    if(score > bestScore){ bestScore = score; }
    updateStats();
    saveProgress();
    updatePowerupButtons();
    setTimeout(()=>{ resetBoard(); }, 600);
  }

  function showLevelUp(){
    levelUpBanner.textContent = `LEVEL ${level}!`;
    levelUpBanner.classList.add('show');
    setTimeout(()=> levelUpBanner.classList.remove('show'), 1500);
  }

  function stop(){ resetBoard(); }

  function addLog(msg, cls=''){
    const div = document.createElement('div');
    if(cls) div.className = cls;
    div.textContent = `[${new Date().toLocaleTimeString()}] ${msg}`;
    logEl.prepend(div);
    if(logEl.children.length > 50){ logEl.lastChild?.remove(); }
  }

  startBtn.addEventListener('click', start);
  stopBtn.addEventListener('click', stop);
  resetBtn.addEventListener('click', resetProgress);
  submitBtn.addEventListener('click', submit);
  answerInput.addEventListener('keydown', e=> { if(e.key==='Enter') submit(); });
  
  pwSlowTime.addEventListener('click', ()=>{ if(slowTimePower<3) slowTimePower++; updatePowerupButtons(); });
  pwHint.addEventListener('click', useHint);
  pwSkip.addEventListener('click', useSkip);

  document.addEventListener('keydown', e=>{
    if(e.code==='Space'){ e.preventDefault(); if(!running) start(); }
    if(e.key==='1' && slowTimePower<3){ slowTimePower++; updatePowerupButtons(); }
    if(e.key==='2'){ useHint(); }
    if(e.key==='3'){ useSkip(); }
  });

  loadProgress();
  bestScoreEl.textContent = bestScore;
  resetBoard();
})();
</script>
</body>
</html>
