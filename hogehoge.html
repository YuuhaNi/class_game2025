<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>SHOCK REFLEX — 目覚まし反射ゲーム</title>
  <style>
    :root{
      --bg:#0a0a0f; --fg:#e6e6f0; --accent1:#00f5d4; --accent2:#f15bb5; --accent3:#fee440; --accent4:#00bbf9;
      --shakeX:0px; --shakeY:0px; --glow:0 0 30px rgba(255,255,255,.15);
    }
    html,body{height:100%; margin:0; background:var(--bg); color:var(--fg); font-family: system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Noto Sans JP",sans-serif; overflow:hidden}
    .wrap{position:relative; height:100%; display:grid; grid-template-rows:auto 1fr auto;}
    header, footer{padding:10px 14px; opacity:.85}
    header{display:flex; align-items:center; gap:10px; font-weight:700; letter-spacing:.08em}
    .badge{font-size:12px; padding:4px 8px; border:1px solid #fff2; border-radius:999px; opacity:.8}
    .stage{position:relative; overflow:hidden;}
    canvas{position:absolute; inset:0; width:100%; height:100%;}
    .ui{position:absolute; inset:0; display:grid; place-items:center; pointer-events:none}
    .panel{pointer-events:auto; text-align:center; max-width:min(720px,92vw); padding:24px; border-radius:16px; backdrop-filter: blur(6px) saturate(1.2); background:radial-gradient(120% 120% at 50% 30%, #ffffff10, #00000040); box-shadow:var(--glow)}
    .title{font-size: clamp(28px,6vw,48px); font-weight:900; letter-spacing:.06em; line-height:1.1; margin:0 0 4px}
    .subtitle{font-size: clamp(14px,2.6vw,18px); opacity:.82; margin:4px 0 20px}
    .big{font-size: clamp(36px,10vw,120px); font-weight:900; letter-spacing:.06em; line-height:1; margin:0}
    .big .unit{font-size: .35em; opacity:.8}
    .controls{display:flex; flex-wrap:wrap; gap:10px; justify-content:center}
    button{all:unset; cursor:pointer; padding:12px 18px; border-radius:12px; border:1px solid #ffffff22; background:linear-gradient(180deg,#ffffff20,#00000020); box-shadow: 0 6px 20px #0006; font-weight:800; letter-spacing:.06em}
    button:hover{transform: translateY(-1px)}
    .primary{background:linear-gradient(120deg,var(--accent1),var(--accent4)); color:#001314}
    .danger{background:linear-gradient(120deg,#ff5449,#ffb800); color:#1a0b00}
    .meter{height:10px; width:100%; background:#ffffff14; border-radius:999px; overflow:hidden; margin-top:14px}
    .meter > div{height:100%; width:0%; background:linear-gradient(90deg,var(--accent2),var(--accent3)); transition:width .2s ease}
    .row{display:flex; gap:14px; justify-content:center; flex-wrap:wrap; align-items:center}
    .stat{display:grid; gap:4px; min-width:120px}
    .stat .label{opacity:.7; font-size:12px; letter-spacing:.08em}
    .stat .val{font-weight:900; font-size:20px}
    .flash{position:absolute; inset:-20px; background: #fff; opacity:0; pointer-events:none}

    /* Vibrations & glitches via transform */
    .shake{transform: translate(var(--shakeX), var(--shakeY));}

    /* Neon gradient background */
    .bgfx{position:absolute; inset:-20%; background:
      radial-gradient(60% 40% at 20% 20%, #00f5d422 0%, transparent 70%),
      radial-gradient(50% 35% at 80% 20%, #f15bb522 0%, transparent 70%),
      radial-gradient(70% 50% at 50% 90%, #00bbf922 0%, transparent 70%);
      filter: blur(30px) contrast(1.2); animation: float 18s ease-in-out infinite alternate}
    @keyframes float { from{transform: translateY(-2%) scale(1)} to{transform: translateY(3%) scale(1.04)} }

    /* Accessibility tip */
    .warn{font-size:12px; opacity:.65}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="badge">⚡ SHOCK REFLEX</div>
      <div class="badge">SPACE / TAP で操作</div>
      <div class="badge" id="bestBadge">BEST: -- ms</div>
    </header>

    <div class="stage shake" id="stage">
      <div class="bgfx"></div>
      <canvas id="fx"></canvas>
      <div class="flash" id="flash"></div>
      <div class="ui">
        <div class="panel" id="panel">
          <h1 class="title">目の覚めるような一撃の瞬間を狙え。</h1>
          <p class="subtitle">合図が出たら <strong>できるだけ早く</strong> 反応！早すぎは<strong>フライング</strong>です。</p>
          <div class="controls">
            <button class="primary" id="startBtn">ゲーム開始 (SPACE)</button>
            <button id="practiceBtn">練習モード</button>
          </div>
          <div class="meter" aria-hidden>
            <div id="meterBar"></div>
          </div>
          <div class="row" style="margin-top:14px">
            <div class="stat"><div class="label">ラウンド</div><div class="val" id="round">0 / 5</div></div>
            <div class="stat"><div class="label">スコア</div><div class="val" id="score">0</div></div>
            <div class="stat"><div class="label">最速</div><div class="val" id="fastest">-- ms</div></div>
          </div>
          <p class="warn">※ 激しい画面揺れとフラッシュ効果があります。体調に不安のある方はプレイを控えてください（強い点滅は避けています）。</p>
        </div>
      </div>
    </div>

    <footer>
      <small>© 2025 Shock Reflex — シングルHTML版</small>
    </footer>
  </div>

<script>
(() => {
  const stage = document.getElementById('stage');
  const panel = document.getElementById('panel');
  const startBtn = document.getElementById('startBtn');
  const practiceBtn = document.getElementById('practiceBtn');
  const meterBar = document.getElementById('meterBar');
  const scoreEl = document.getElementById('score');
  const roundEl = document.getElementById('round');
  const fastestEl = document.getElementById('fastest');
  const bestBadge = document.getElementById('bestBadge');
  const flash = document.getElementById('flash');

  // Canvas particle FX
  const cvs = document.getElementById('fx');
  const ctx = cvs.getContext('2d');
  const DPR = Math.max(1, Math.min(2, window.devicePixelRatio || 1));
  const particles = [];

  function resize(){
    const {clientWidth:w, clientHeight:h} = stage;
    cvs.width = Math.floor(w * DPR);
    cvs.height = Math.floor(h * DPR);
    cvs.style.width = w + 'px';
    cvs.style.height = h + 'px';
    ctx.setTransform(DPR,0,0,DPR,0,0);
  }
  addEventListener('resize', resize); resize();

  function spawnShockwave(x,y, power=1){
    for(let i=0;i<180;i++){
      const a = (i/180)*Math.PI*2;
      const s = (Math.random()*2+1) * power;
      particles.push({x,y, vx: Math.cos(a)*s, vy: Math.sin(a)*s, life: 60+Math.random()*30, size: 2+Math.random()*2, hue: (a*180/Math.PI + (Math.random()*40-20))%360, alpha:1});
    }
  }

  function tick(){
    ctx.clearRect(0,0,cvs.width,DPR?cvs.height/DPR:cvs.height);
    for(let i=particles.length-1;i>=0;i--){
      const p = particles[i];
      p.x += p.vx; p.y += p.vy;
      p.vy += 0.02; // gravity
      p.life--; p.alpha = Math.max(0, p.life/90);
      ctx.globalAlpha = p.alpha; ctx.fillStyle = `hsl(${p.hue} 90% 60%)`;
      ctx.beginPath(); ctx.arc(p.x,p.y,p.size,0,Math.PI*2); ctx.fill();
      if(p.life<=0) particles.splice(i,1);
    }
    requestAnimationFrame(tick);
  }
  tick();

  // Audio — pure WebAudio (no external files)
  const audio = new (window.AudioContext || window.webkitAudioContext)();
  function boom(){
    const o = audio.createOscillator();
    const g = audio.createGain();
    const c = audio.createBiquadFilter();
    c.type='lowpass'; c.frequency.value=600;
    o.type='square';
    o.frequency.setValueAtTime(180, audio.currentTime);
    o.frequency.exponentialRampToValueAtTime(40, audio.currentTime + 0.15);
    g.gain.setValueAtTime(0.0001, audio.currentTime);
    g.gain.exponentialRampToValueAtTime(0.8, audio.currentTime + 0.02);
    g.gain.exponentialRampToValueAtTime(0.0001, audio.currentTime + 0.35);
    o.connect(c).connect(g).connect(audio.destination);
    o.start(); o.stop(audio.currentTime + 0.4);
  }
  function clickHi(){
    const o = audio.createOscillator();
    const g = audio.createGain();
    o.type='triangle'; o.frequency.value=1200;
    g.gain.value=0.15; o.connect(g).connect(audio.destination);
    o.start(); o.stop(audio.currentTime + 0.05);
  }

  // Game state
  const ROUNDS = 5;
  let round = 0; let score = 0; let fastest = Infinity; let best = +(localStorage.getItem('shockreflex_best')||0);
  updateBestBadge();

  let waiting=false, readyTime=0, fired=false, practice=false, lock=false;

  function updateBestBadge(){ bestBadge.textContent = `BEST: ${best?best+" ms":"-- ms"}`; }

  function setPanel(html){ panel.innerHTML = html; }

  function setShake(px=0, py=0){
    stage.style.setProperty('--shakeX', px+'px');
    stage.style.setProperty('--shakeY', py+'px');
  }

  function screenFlash(){
    flash.style.transition = 'none'; flash.style.opacity = 0.85;
    requestAnimationFrame(()=>{ flash.style.transition = 'opacity .20s ease-out'; flash.style.opacity = 0; });
  }

  function startGame(prac=false){
    practice = prac; round = 0; score = 0; fastest = Infinity; fired=false; waiting=false; lock=false;
    scoreEl.textContent = '0'; roundEl.textContent = `0 / ${practice?"∞":ROUNDS}`; fastestEl.textContent = '-- ms';
    meterBar.style.width = '0%';
    nextRound();
  }

  function nextRound(){
    if(!practice && round>=ROUNDS){ return finishGame(); }
    round++;
    roundEl.textContent = `${practice?round:"" + round} / ${practice?"∞":ROUNDS}`;
    setPanel(`<h2 class="title">静かに待て…</h2><p class="subtitle">ランダムタイミングで合図が出ます。早押しは<strong>フライング</strong>。</p><p class="big" id="count">…</p>`);
    meterBar.style.width = '0%';

    const delay = 1200 + Math.random()*2000; // 1.2s–3.2s
    waiting = true; fired=false; lock=false;
    setShake(0,0);

    const startAt = performance.now();

    const t1 = setTimeout(()=>{
      waiting = false; readyTime = performance.now();
      setPanel(`<p class="subtitle">今だ！</p><p class="big" id="now">NOW<span class="unit">!</span></p>`);
      boom(); screenFlash();

      // FX
      const rect = stage.getBoundingClientRect();
      spawnShockwave(rect.width/2, rect.height/2, 1.2);

      // gentle shake
      let k=14, d=0;
      const sh = () => { if(d>18){ setShake(0,0); return; } d++; setShake((Math.random()*2-1)*k,(Math.random()*2-1)*k); k*=0.75; requestAnimationFrame(sh); };
      sh();
    }, delay);

    // Update meter while waiting
    const meterStart = performance.now();
    function meterTick(){
      if(!waiting) return;
      const p = Math.min(1, (performance.now()-meterStart)/delay);
      meterBar.style.width = (p*100).toFixed(1)+'%';
      requestAnimationFrame(meterTick);
    }
    meterTick();
  }

  function handlePress(){
    if(lock) return; // prevent double taps
    lock=true; setTimeout(()=>lock=false, 60);
    clickHi();

    if(waiting){ // false start
      fired=true; waiting=false;
      setPanel(`<h2 class="title">フライング！</h2><p class="subtitle">合図の前に押しました。</p><p class="big">+200 <span class="unit">ms</span></p><div class="controls"><button class="danger" id="cont">続ける</button></div>`);
      score -= 200; if(score<0) score=0; scoreEl.textContent=score;
      document.getElementById('cont').onclick = nextRound;
      setShake(10,-10); screenFlash();
      return;
    }

    if(!fired && !waiting && readyTime>0){
      const rt = Math.max(0, Math.round(performance.now()-readyTime));
      fastest = Math.min(fastest, rt); fastestEl.textContent = fastest + ' ms';
      const gain = Math.max(0, 1000 - rt);
      score += gain; scoreEl.textContent = score;
      setPanel(`<h2 class="title">反応速度</h2><p class="big">${rt} <span class="unit">ms</span></p><p class="subtitle">スコア +${gain}</p><div class="controls"><button class="primary" id="next">次へ</button> <button id="retry">やり直す</button></div>`);
      document.getElementById('next').onclick = nextRound;
      document.getElementById('retry').onclick = ()=>startGame(practice);

      // FX
      const rect = stage.getBoundingClientRect();
      spawnShockwave(rect.width/2, rect.height/2, 0.8 + Math.max(0,1.4-rt/500));
      screenFlash();
      fired=true;
    }
  }

  function finishGame(){
    setPanel(`<h2 class="title">結果</h2>
      <div class="row" style="margin:10px 0 18px">
        <div class="stat"><div class="label">総スコア</div><div class="val">${score}</div></div>
        <div class="stat"><div class="label">最速</div><div class="val">${fastest===Infinity?'--':fastest+' ms'}</div></div>
      </div>
      <div class="controls"><button class="primary" id="again">もう一度</button></div>`);
    if(fastest < (best||Infinity)) { best = fastest; localStorage.setItem('shockreflex_best', String(best)); updateBestBadge(); }
    document.getElementById('again').onclick = ()=>startGame(false);
  }

  // Inputs
  function onKey(e){ if(e.code==='Space' || e.key===' '){ e.preventDefault(); handlePress(); } }
  function onClick(){ handlePress(); }
  addEventListener('keydown', onKey);
  stage.addEventListener('pointerdown', onClick);

  // Initial buttons
  startBtn.addEventListener('click', ()=>startGame(false));
  practiceBtn.addEventListener('click', ()=>startGame(true));

  // Update header best on load
  updateBestBadge();
})();
</script>
</body>
</html>
